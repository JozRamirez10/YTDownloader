<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Descargar Videos de YouTube</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5 pb-5">
    <h1 class="text-center">Descargar Videos de YouTube</h1>
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="youtubeUrl" class="form-label">URL del video</label>
                <input type="text" id="youtubeUrl" class="form-control" placeholder="Ingrese la URL del video">
            </div>
            <div class="mb-3">
                <label for="format" class="form-label">Formato</label>
                <select id="format" class="form-select">
                    <option value="video">Video</option>
                    <option value="audio">Audio</option>
                </select>
            </div>
            <button id="fetchInfoBtn" class="btn btn-info w-100 mb-3">Obtener Información</button>
            <div id="videoInfo" class="mb-3 d-none">
                <h5 id="videoTitle" class="text-center"></h5>
                <img id="videoThumbnail" class="img-fluid mx-auto d-block" alt="Video Thumbnail">
            </div>
            <button id="downloadBtn" class="btn btn-primary w-100 d-none">Descargar</button>
            <div class="progress mt-3 d-none" id="progressBarContainer">
                <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%;">0%</div>
            </div>
            <div id="statusMessage" class="mt-3 text-center"></div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const fetchInfoBtn = document.getElementById('fetchInfoBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const youtubeUrl = document.getElementById('youtubeUrl');
        const statusMessage = document.getElementById('statusMessage');
        const videoInfo = document.getElementById('videoInfo');
        const videoTitle = document.getElementById('videoTitle');
        const videoThumbnail = document.getElementById('videoThumbnail');
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');

        fetchInfoBtn.addEventListener('click', async () => {
            
            downloadBtn.classList.add("d-none");
            videoInfo.classList.add("d-none");

            const url = youtubeUrl.value.trim();
            if (!url) {
                statusMessage.textContent = 'Por favor, ingrese una URL válida.';
                statusMessage.className = 'text-danger';
                return;
            }

            statusMessage.textContent = 'Obteniendo información del video...';
            statusMessage.className = 'text-info';

            try {
                const response = await fetch('/video-info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url }),
                });

                if (!response.ok) throw new Error('Error al obtener la información del video.');

                const data = await response.json();
                videoTitle.textContent = data.title;
                videoThumbnail.src = data.thumbnail;
                videoInfo.classList.remove('d-none');
                downloadBtn.classList.remove('d-none');
                statusMessage.textContent = '';
            } catch (err) {
                console.error(err);
                statusMessage.textContent = 'Error al obtener la información del video.';
                statusMessage.className = 'text-danger';
            }
        });

        downloadBtn.addEventListener('click', async () => {
            const url = youtubeUrl.value.trim();
            const format = document.getElementById('format').value;

            if (!url) {
                statusMessage.textContent = 'Por favor, ingrese una URL válida.';
                statusMessage.className = 'text-danger';
                return;
            }

            statusMessage.textContent = 'Iniciando la descarga...';
            statusMessage.className = 'text-info';
            progressBarContainer.classList.remove('d-none');

            try {
                const response = await fetch('/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, format }),
                });

                if (!response.ok) throw new Error('Error al descargar el archivo.');

                const contentDisposition = response.headers.get('Content-Disposition');
                const fileNameMatch = contentDisposition && contentDisposition.match(/filename="(.+)"/);
                const fileName = fileNameMatch ? fileNameMatch[1] : 'download';

                const reader = response.body.getReader();
                const contentLength = +response.headers.get('Content-Length');
                let receivedLength = 0;

                let chunks = [];
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    receivedLength += value.length;

                    const progress = Math.round((receivedLength / contentLength) * 100);
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = progress + '%';
                }

                const blob = new Blob(chunks);
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = fileName;
                a.click();

                statusMessage.textContent = 'Descarga completada.';
                statusMessage.className = 'text-success';
                youtubeUrl.value = '';
                progressBarContainer.classList.add('d-none');
            } catch (err) {
                console.error(err);
                statusMessage.textContent = 'Error al procesar la descarga.';
                statusMessage.className = 'text-danger';
                progressBarContainer.classList.add('d-none');
            }
        });
    </script>
</body>
</html>
